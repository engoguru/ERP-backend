

# name: Backend-ERP

# on:
#   push:
#     branches:
#       - master

# jobs:

#   test:
#     name: Run Tests
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout Source
#         uses: actions/checkout@v4

#       - name: Setup Node.js
#         uses: actions/setup-node@v3
#         with:
#           node-version: '20'

#       - name: Install Dependencies
#         run: npm ci

#       - name: Run Tests
#         run: npm test

#   build:
#     name: Build and Push Docker Image
#     needs: test       # Only runs if tests pass
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout Source
#         uses: actions/checkout@v4

#       - name: Login to Docker Hub
#         run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

#       - name: Build Docker Image
#         run: docker build -t ${{ secrets.DOCKER_USERNAME }}/erp-backend:${{ github.sha }} .

#       - name: Push Docker Image
#         run: docker push ${{ secrets.DOCKER_USERNAME }}/erp-backend:${{ github.sha }}

#   deploy:
#     name: Deploy to EC2
#     needs: build     # Only runs if build succeeds
#     runs-on: self-hosted
#     steps:
#       - name: Pull Latest Docker Image
#         run: docker pull ${{ secrets.DOCKER_USERNAME }}/erp-backend:${{ github.sha }}

#       - name: Remove Old Container
#         run: |
#           if [ "$(docker ps -aq -f name=erp-backend-service)" ]; then
#             docker rm -f erp-backend-service
#           fi

#       - name: Run New Docker Container
#         run: |
#           docker run -d -p ${{ secrets.PORT }}:${{ secrets.PORT }} \
#           --name erp-backend-service \
#           --restart unless-stopped \
#           -e AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }} \
#           -e AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }} \
#           -e AWS_REGION=${{ secrets.AWS_REGION }} \
#           -e S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }} \
#           -e JWT_SECRET=${{ secrets.JWT_SECRET }} \
#           -e MONGO_URI=${{ secrets.MONGO_URI }} \
#           -e PORT=${{ secrets.PORT }} \
#           ${{ secrets.DOCKER_USERNAME }}/erp-backend:${{ github.sha }}
name: Backend-ERP

on:
  push:
    branches:
      - master

jobs:

  build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

      - name: Build Docker Image
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/erp-backend:${{ github.sha }} .

      - name: Push Docker Image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/erp-backend:${{ github.sha }}

  deploy:
    name: Deploy to EC2
    needs: build     # Only runs if build succeeds
    runs-on: self-hosted
    steps:
      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

      - name: Pull Latest Docker Image
        run: docker pull ${{ secrets.DOCKER_USERNAME }}/erp-backend:${{ github.sha }}

      - name: Remove Old Container
        run: |
          if [ "$(docker ps -aq -f name=erp-backend-service)" ]; then
            docker rm -f erp-backend-service
          fi

      - name: Run New Docker Container
        run: |
          docker run -d -p ${{ secrets.PORT }}:${{ secrets.PORT }} \
          --name erp-backend-service \
          --restart unless-stopped \
          -e AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }} \
          -e AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }} \
          -e AWS_REGION=${{ secrets.AWS_REGION }} \
          -e S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }} \
          -e JWT_SECRET=${{ secrets.JWT_SECRET }} \
          -e MONGO_URI=${{ secrets.MONGO_URI }} \
          -e PORT=${{ secrets.PORT }} \
          ${{ secrets.DOCKER_USERNAME }}/erp-backend:${{ github.sha }}
